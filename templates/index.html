<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Cats Combo Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üê± Battle Cats Combo Calculator</h1>
            <p>Find the optimal combination of cats to achieve your desired combo effect!</p>
        </header>

        <main>
            <div class="controls">
                <div class="control-group">
                    <label for="effectType">Effect Type:</label>
                    <select id="effectType" required>
                        <option value="">Select an effect type...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="strength">Minimum Strength:</label>
                    <select id="strength" required>
                        <option value="1">S (1)</option>
                        <option value="2">M (2)</option>
                        <option value="3">L (3)</option>
                        <option value="4">XL (4)</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="maxCats">Maximum Cats:</label>
                    <select id="maxCats">
                        <option value="3">3 cats</option>
                        <option value="4">4 cats</option>
                        <option value="5" selected>5 cats</option>
                    </select>
                </div>

                <button id="findCombos" onclick="findCombinations()">Find Combinations</button>
            </div>

            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Calculating combinations...</p>
            </div>

            <div id="results" class="results hidden">
                <h2>Results</h2>
                <div id="resultsCount" class="results-count"></div>
                <div id="resultsList" class="results-list"></div>
            </div>

            <div id="error" class="error hidden">
                <h3>Error</h3>
                <p id="errorMessage"></p>
            </div>
        </main>

        <footer>
            <p>Data from Battle Cats Wiki ‚Ä¢ Evolution forms automatically included</p>
        </footer>
    </div>

    <script>
        let effectTypes = [];

        // Load effect types on page load
        async function loadEffectTypes() {
            try {
                const response = await fetch('/api/effect-types');
                effectTypes = await response.json();
                
                const select = document.getElementById('effectType');
                effectTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading effect types:', error);
                showError('Failed to load effect types');
            }
        }

        // Find combinations
        async function findCombinations() {
            const effectType = document.getElementById('effectType').value;
            const strength = document.getElementById('strength').value;
            const maxCats = document.getElementById('maxCats').value;

            if (!effectType) {
                showError('Please select an effect type');
                return;
            }

            hideError();
            hideResults();
            showLoading();

            try {
                const response = await fetch(`/api/find-combinations?effect_type=${encodeURIComponent(effectType)}&strength=${strength}&max_cats=${maxCats}`);
                const data = await response.json();

                hideLoading();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                showResults(data);
            } catch (error) {
                hideLoading();
                console.error('Error finding combinations:', error);
                showError('Failed to find combinations. Please try again.');
            }
        }

        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            const countDiv = document.getElementById('resultsCount');
            const listDiv = document.getElementById('resultsList');

            countDiv.textContent = `Found ${data.total_found} combination${data.total_found !== 1 ? 's' : ''}`;

            if (data.total_found === 0) {
                listDiv.innerHTML = '<div class="no-results">No combinations found for the selected criteria.</div>';
            } else {
                listDiv.innerHTML = data.results.map((result, index) => `
                    <div class="result-item">
                        <div class="result-header">
                            <h3>Option ${index + 1}</h3>
                            <div class="result-stats">
                                <span class="stat">Strength: ${result.total_strength}</span>
                                <span class="stat">Cats: ${result.cat_count}</span>
                                <span class="stat">Combos: ${result.combos.length}</span>
                            </div>
                        </div>
                        <div class="result-content">
                            <div class="combo-section">
                                <h4>Combo${result.combos.length > 1 ? 's' : ''}:</h4>
                                <ul class="combo-list">
                                    ${result.combos.map(combo => `<li>${combo}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="cats-section">
                                <h4>Required Cats:</h4>
                                <div class="cats-grid">
                                    ${result.cats.map(cat => `<span class="cat-name">${cat}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            resultsDiv.classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('results').classList.add('hidden');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', loadEffectTypes);

        // Allow Enter key to trigger search
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                findCombinations();
            }
        });
    </script>
</body>
</html>
